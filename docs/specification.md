# シャドーイングアプリの仕様

## 概要
個人使用向けのシャドーイングアプリ。英語学習者が音声を使ってシャドーイング練習を行うことができる。

## 主要機能
アプリは「課題管理」「シャドーイング」「設定」の3項目からなる。

## 課題管理

- 「課題作成」「課題修正」「課題削除」からなる。

### 課題作成

- ユーザーはタイトルと、50単語-300単語の英文を入力する。
- 課題作成が選択されると、アプリはシャドーイング課題を作成する
    - シャドーイング課題は、複数のターンからなる
    - ターンは1つもしくは複数の文からなり、ターンの区切りは文末になっている。文末は句読点（. ! ?）を基準とする。
    - 各ターンに含める文の決定は、次のように決める。
        - 前から文をみてターンを決定していく
        - いまみている文が10単語以上であるならば、その文だけでターンとする。
        - いまみている文が10単語未満であるとき、10単語を超えるまで次の文を同じターンに含めることを繰り返す。
            - ただし、複数の文からなる30単語以上のターンは作らない。次の文を含めると単語数が30単語以上になるとき、その次の文を含めないでターンとする
- アプリはシャドーイング課題の必要な音声を作成し、ローカルに保存する。

### 課題編集

- 課題のタイトルのみ編集できる

### 課題削除

- 既存の作成された課題を削除できる
- 削除時に確認ダイアログを表示
- 削除すると関連する音声データや成績データも完全に削除される

### 課題一覧表示

- 作成済み課題の一覧を表示
- 各課題について以下の情報を表示：
    - タイトル
    - 作成日時
    - 最高スコア（実施済みの場合）
    - 実施回数
- ソート機能（作成日時、スコア、タイトル順）

## シャドーイング

### 課題選択
- ユーザーは、作成された課題を選択し、リスニングまたはシャドーイングを行うことができる
- 課題選択画面では過去の成績も確認可能

### リスニング
- 画面には英文が表示されており、アプリが読み上げる。
    - 英文はターン別に表示されているが、音声は最初から最後まで流して再生される。

### シャドーイング実行
- シャドーイングは、ユーザーがスタートを指示すると開始される（「開始」ボタン）
- シャドーイング画面では、英語テキストは表示されない
- シャドーイングでは、各ターンで次のことが起こる
    - アプリが、OpenAI TTS APIを使用して各ターンの音声を読み上げる
    - ユーザーは、アプリの読み上げ開始に数秒遅れて、音声を復唱する
        - アプリは、読み上げを開始すると同時に録音を開始する
    - ユーザーは、読み上げが完了すると、ターンの終了を指示する（「次へ」ボタン）
        - 最後のターンを除いて、「次へ」ボタンを押すと次のターンが始まり、次のターンの音声読み上げが開始される
- 進行状況表示（現在のターン / 総ターン数）
- 一時停止・再開機能
- やり直し機能（現在のターンをもう一度）

### 音声制御
- 音声録音の開始/停止の明確な表示
- マイクの使用許可確認（Google Chrome）
- 音声レベルの視覚的表示

### 採点システム
- シャドーイングが終了すると、採点が行われる
    - アプリは、OpenAI Whisper APIを使用してユーザーの読み上げた音声を書き起こす
        - フィラーや軽微な単語の読み間違えは柔軟に解釈し、自然な英文を書き起こす
    - アプリは、ユーザーの読み上げた音声の書き起こしと課題のテキストを比較し、一致率を算出する
        - 単語レベルでの一致率計算
        - 大文字小文字は区別しない
        - 句読点は評価対象外
    - アプリは、ユーザーの音声を書き起こしたものと一致率を画面に表示する
        - 課題全体の一致率のみ表示（ターン別は不要）
        - 間違った部分のハイライト表示
    - 課題ごとに、最も高い一致率をアプリに保存する
    - 実施履歴の保存（日時とスコアのみ）

## 設定
- ユーザーは以下の項目を設定できる。これらは、課題作成時に音声を作成するときの設定を意味する。
    - 読み上げの速さ：1.0倍から2.0倍の範囲で、0.1倍ずつの粒度で設定できる
    - 読み上げの音声の種類：OpenAIのAPIでサポートされている音声の種類を変更可能

## 補足事項

### データ保存内容
- 課題データ（タイトル、英文、ターン分割情報）
- 成績データ（実施日時、スコア、認識結果）
- 設定データ（音声設定、システム設定）

### 技術的制約
- ローカル環境での動作が前提
- OpenAI APIキーが必要（.envファイルで管理）
- マイクアクセス許可が必要
- Google Chromeでの動作を想定

### 注意事項
- 音声データ自体は保存せず、認識結果のテキストのみ保存
- 個人使用を想定したシンプルな設計

---

**技術的な詳細については `docs/architecture.md` を参照してください。**